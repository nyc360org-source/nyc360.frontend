###############################################
#          ANGULAR + GOOGLE + SECURITY        #
#                FULL .HTACCESS               #
###############################################

# ===========================================
# 1) FORCE HTTPS  (Google OAuth Required)
# ===========================================
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# ===========================================
# 2) GOOGLE OAuth / Google Identity
# ===========================================
<IfModule mod_headers.c>

  # Allow Google Domains
  Header always set Access-Control-Allow-Origin "https://accounts.google.com"
  Header always set Access-Control-Allow-Credentials "true"
  Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
  Header always set Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization"

  # Required security for Google login popups
  Header always set Cross-Origin-Opener-Policy "same-origin"
  Header always set Cross-Origin-Embedder-Policy "require-corp"
  Header always set Cross-Origin-Resource-Policy "cross-origin"

  # Content Security Policy (most important for preventing OAuth blocking)
  Header always set Content-Security-Policy "
    default-src 'self';
    img-src 'self' data: https:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com;
    frame-src https://accounts.google.com https://*.google.com;
    connect-src 'self' https://www.googleapis.com https://accounts.google.com https://oauth2.googleapis.com;
    font-src 'self' data:;
    media-src 'self';
    object-src 'none';
  "

</IfModule>

# ===========================================
# 3) ANGULAR SPA ROUTING
# ===========================================
<IfModule mod_rewrite.c>
  RewriteEngine On
  # If file or folder exists â†’ Allow
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # Otherwise route to index.html
  RewriteRule ^ /index.html [L]
</IfModule>

# ===========================================
# 4) BROWSER CACHING (FASTEST CONFIG)
# ===========================================
<IfModule mod_expires.c>
  ExpiresActive On

  # Cache static hashed assets
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/json "access plus 1 month"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"

  # Do NOT cache index.html
  ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# Extra cache headers
<IfModule mod_headers.c>

  <FilesMatch "\.(css|js|png|jpg|jpeg|svg|ico|webp|woff2)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  <FilesMatch "index\.html$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
  </FilesMatch>

</IfModule>

# ===========================================
# 5) GZIP & BROTLI COMPRESSION (FASTER SPEED)
# ===========================================
# Enable Gzip
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Enable Brotli if supported
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/javascript application/json
  BrotliCompressionQuality 6
</IfModule>

# ===========================================
# 6) SECURITY HARDENING
# ===========================================
<IfModule mod_headers.c>

  # Prevent MIME sniffing
  Header always set X-Content-Type-Options "nosniff"

  # Prevent iframe embedding
  Header always set X-Frame-Options "SAMEORIGIN"

  # XSS Protection
  Header always set X-XSS-Protection "1; mode=block"

  # Prevent referrer leaks
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # Prevent old, weak transfers
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# ===========================================
# 7) REMOVE .htaccess ACCESS DIRECTLY
# ===========================================
<Files ".htaccess">
  Order allow,deny
  Deny from all
</Files>

###############################################
# END OF FILE
###############################################
