<div class="page-container luxury-theme">

  <div class="page-header fade-in-down">
    <div class="title-section">
      <h2 class="gold-text">
        {{ isEditMode ? 'EDIT POST' : 'CREATE NEW POST' }}
        <span *ngIf="predefinedCategory !== null" class="ms-2 text-muted"
          style="font-size: 0.6em; vertical-align: middle;">
          <i class="bi bi-caret-right-fill"></i> {{ getCategoryName(predefinedCategory) | uppercase }}
        </span>
      </h2>
      <p class="subtitle">Share your story with the world.</p>
    </div>
    <button (click)="goBack()" class="btn-back">
      <i class="bi bi-arrow-left"></i> Back
    </button>

  </div>

  <div class="form-card glass-panel fade-in-up">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">

      <!-- Title & Type Row -->
      <div class="form-row">
        <div class="form-group col-md-8">
          <label>POST TITLE <span class="req">*</span></label>
          <div class="input-wrapper">
            <i class="bi bi-type-h1"></i>
            <input type="text" formControlName="title" placeholder="Enter a captivating headline...">
          </div>
          <small class="error-msg" *ngIf="form.get('title')?.invalid && form.get('title')?.touched">
            Title is required (min 5 chars).
          </small>
        </div>

        <div class="form-group col-md-4">
          <label>POST TYPE <span class="req">*</span></label>
          <div class="input-wrapper">
            <i class="bi bi-layers-fill"></i>
            <select formControlName="type">
              <option *ngFor="let type of postTypes" [value]="type.id">{{ type.name }}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Category & Location Search Row -->
      <div class="form-row">
        <div class="form-group col-md-6" *ngIf="predefinedCategory === null">
          <label>CATEGORY <span class="req">*</span></label>
          <div class="input-wrapper">
            <i class="bi bi-grid-fill"></i>
            <select formControlName="category">
              <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
            </select>
          </div>
        </div>

        <div class="form-group col-md-6 position-relative" [class.col-md-12]="predefinedCategory !== null">
          <label>LOCATION <span class="req">*</span></label>
          <div class="input-wrapper">
            <i class="bi bi-geo-alt-fill"></i>
            <input type="text" formControlName="locationSearch" placeholder="Search Neighborhood (e.g. Bronx)"
              (input)="onLocationInput($event)" autocomplete="off">
          </div>
          <!-- Location Dropdown -->
          <ul class="dropdown-results" *ngIf="showLocationDropdown">
            <li *ngFor="let loc of locationResults" (click)="selectLocation(loc)">
              <strong>{{ loc.neighborhoodNet }}</strong>
              <small>{{ loc.borough }} - {{ loc.zipCode }}</small>
            </li>
          </ul>
          <small class="error-msg" *ngIf="!selectedLocation && form.get('locationSearch')?.touched">
            Please select a valid location from the list.
          </small>
        </div>
      </div>

      <!-- Content -->
      <div class="form-group">
        <label>CONTENT <span class="req">*</span></label>
        <div class="textarea-wrapper">
          <textarea formControlName="content" rows="10" placeholder="Write your article content here..."></textarea>
        </div>
        <small class="error-msg" *ngIf="form.get('content')?.invalid && form.get('content')?.touched">
          Content is required (min 20 chars).
        </small>
      </div>

      <!-- Tags Search -->
      <div class="form-group position-relative">
        <label>TAGS <small class="text-muted">â€“ Search & Select</small></label>
        <div class="input-wrapper">
          <i class="bi bi-tags-fill"></i>
          <input type="text" placeholder="Search tags..." (input)="onTagInput($event)" autocomplete="off">
        </div>

        <!-- Tag Dropdown -->
        <ul class="dropdown-results" *ngIf="showTagDropdown">
          <li *ngFor="let tag of tagResults" (click)="selectTag(tag)">
            {{ tag.name }}
          </li>
        </ul>

        <div class="tags-list mt-3" *ngIf="selectedTags.length > 0">
          <span class="tag-badge" *ngFor="let tag of selectedTags; let i = index">
            {{ tag.name }}
            <i class="bi bi-x-circle-fill remove-tag" (click)="removeTag(i)"></i>
          </span>
        </div>
      </div>

      <!-- Attachments -->
      <div class="form-group">
        <!-- Existing Attachments -->
        <div class="existing-attachments mb-3" *ngIf="existingAttachments.length > 0">
          <label class="small text-muted uppercase">Current Attachments</label>
          <div class="attachments-preview">
            <div class="preview-item" *ngFor="let att of existingAttachments; let i = index">
              <!-- Simple check for video extension in URL if possible, otherwise assume image for existing -->
              <img [src]="resolveImageUrl(att.url)" alt="Existing"
                *ngIf="!att.url.endsWith('.mp4') && !att.url.endsWith('.webm')">
              <video [src]="resolveImageUrl(att.url)" controls
                *ngIf="att.url.endsWith('.mp4') || att.url.endsWith('.webm')"
                style="width: 100%; height: 100%; object-fit: cover;"></video>

              <button type="button" class="btn-remove danger" (click)="removeExistingFile(i, att.id)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="file-upload-zone">
          <input type="file" (change)="onFileSelect($event)" multiple id="fileInput" class="hidden-input"
            accept="image/*,video/*">
          <label for="fileInput" class="upload-label">
            <i class="bi bi-cloud-arrow-up-fill"></i>
            <span>{{ isEditMode ? 'Add more media' : 'Drag images or videos here or click to upload' }}</span>
          </label>
        </div>
        <small class="text-muted d-block mt-1 ms-1" style="font-size: 0.8em;">
          * Allowed: Images (JPG, PNG) & Videos (MP4, WebM). At least one media file is required.
        </small>

        <!-- New Previews -->
        <div class="attachments-preview" *ngIf="imagePreviews.length > 0">
          <div class="preview-item new-file" *ngFor="let item of imagePreviews; let i = index">
            <img [src]="item.url" alt="New Preview" *ngIf="!item.isVideo">
            <video [src]="item.url" controls *ngIf="item.isVideo"
              style="width: 100%; height: 100%; object-fit: cover;"></video>

            <button type="button" class="btn-remove" (click)="removeFile(i)">
              <i class="bi bi-x"></i>
            </button>
            <span class="new-badge">NEW</span>
          </div>
        </div>

        <small class="error-msg" *ngIf="isSubmitting && imagePreviews.length === 0 && existingAttachments.length === 0">
          At least one image or video is required.
        </small>
      </div>

      <!-- Actions -->
      <div class="form-actions border-top pt-4 mt-4">
        <button type="button" (click)="goBack()" class="btn-ghost">CANCEL</button>

        <button type="submit" class="btn-luxury" [disabled]="isLoading">
          <span *ngIf="!isSubmitting">
            <i class="bi bi-send-check-fill"></i> {{ isEditMode ? 'SAVE CHANGES' : 'PUBLISH POST' }}
          </span>
          <span *ngIf="isSubmitting" class="d-flex align-items-center gap-2">
            <span class="spinner-border spinner-border-sm"></span> PROCESSING...
          </span>
        </button>
      </div>

    </form>
  </div>
</div>