<div class="post-page-container">

  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
  </div>

  <div *ngIf="errorMsg" class="alert alert-danger my-4 text-center">
    {{ errorMsg }}
  </div>

  <div *ngIf="post && !isLoading">
    
    <header class="post-header">
      <div class="badge-row">
      </div>
      
      <h1 class="post-title">{{ post.title }}</h1>
      
      <div class="meta-row">
        <div class="d-flex align-items-center author-info">
          <span>{{ post.author.name }}</span>
        </div>
        <span class="separator">â€¢</span>
        <span class="date">{{ post.createdAt | date:'mediumDate' }}</span>
      </div>
    </header>

    <div class="hero-image-wrapper">
      <img [src]="getMainImage()" class="hero-img" alt="Post Cover">
    </div>

    <article class="post-content" [innerHTML]="post.content">
      </article>

    <div class="cta-box mb-5">
      <h2>Enjoying the content?</h2>
      <p>Join our community to get the latest updates and exclusive news directly to your inbox.</p>
      <button class="btn-orange">Subscribe Now</button>
    </div>

    <div class="interaction-bar d-flex align-items-center gap-3 py-4 border-top border-bottom mb-5">
      
      <button class="btn d-flex align-items-center gap-2 px-3 py-2"
              [style.background-color]="post.currentUserInteraction === InteractionType.Like ? '#fff0e6' : '#f8f9fa'"
              [style.color]="post.currentUserInteraction === InteractionType.Like ? '#ff7f50' : '#666'"
              [style.border]="post.currentUserInteraction === InteractionType.Like ? '1px solid #ff7f50' : '1px solid transparent'"
              style="border-radius: 16px; transition: all 0.3s;"
              (click)="toggleInteraction(InteractionType.Like)">
        <i class="bi" [ngClass]="post.currentUserInteraction === InteractionType.Like ? 'bi-hand-thumbs-up-fill' : 'bi-hand-thumbs-up'"></i>
        <span class="fw-bold">{{ post.stats.likes }}</span>
      </button>

      <button class="btn d-flex align-items-center gap-2 px-3 py-2"
              [style.background-color]="post.currentUserInteraction === InteractionType.Dislike ? '#fff0e6' : '#f8f9fa'"
              [style.color]="post.currentUserInteraction === InteractionType.Dislike ? '#dc3545' : '#666'"
              style="border-radius: 16px; transition: all 0.3s;"
              (click)="toggleInteraction(InteractionType.Dislike)">
        <i class="bi" [ngClass]="post.currentUserInteraction === InteractionType.Dislike ? 'bi-hand-thumbs-down-fill' : 'bi-hand-thumbs-down'"></i>
        <span class="fw-bold">{{ post.stats.dislikes }}</span>
      </button>

      <button class="btn btn-light ms-auto px-3 py-2" 
              style="border-radius: 16px; color: #666;"
              (click)="openShareModal()">
      </button>
    </div>

    <div class="related-section" *ngIf="relatedPosts.length > 0">
      <h3 class="mb-4" style="font-family: 'Merriweather', serif;">Related Reads</h3>
      <div class="d-flex flex-column gap-3">
        <div class="related-card" *ngFor="let rel of relatedPosts" [routerLink]="['/posts', rel.id]">
          <h4>{{ rel.title }}</h4>
          <div class="rel-meta">
            <div class="user-tiny">
              <span class="text-primary fw-bold">Read More <i class="bi bi-arrow-right"></i></span>
            </div>
            <span class="date"><i class="bi bi-chat-dots"></i> {{ rel.commentsCount }} comments</span>
          </div>
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <div class="comments-section">
      <div class="sec-head">
        <h3>Comments <span class="count">({{ post.stats.comments }})</span></h3>
        <button class="filter-btn">Newest First <i class="bi bi-chevron-down"></i></button>
      </div>

      <div class="d-flex gap-3 mb-5">
        <div class="flex-shrink-0 d-none d-md-block">
          <div style="width: 48px; height: 48px; background: #eee; border-radius: 50%;"></div>
        </div>
        
        <div class="flex-grow-1">
          <div class="input-group">
            <input type="text" 
                   class="form-control border-0 bg-light px-4 py-3" 
                   placeholder="Write a thoughtful comment..." 
                   [(ngModel)]="newCommentContent" 
                   (keydown.enter)="submitComment()"
                   style="border-radius: 16px 0 0 16px;">
            <button class="btn text-white px-4" 
                    (click)="submitComment()" 
                    [disabled]="!newCommentContent.trim()"
                    style="background-color: #ff7f50; border-radius: 0 16px 16px 0;">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="comments-list">
        <div *ngFor="let comment of comments" class="comment-card featured mb-4">
          
          <div class="comment-header">
            <!-- <img [src]="getAuthorImage(comment.author)" class="c-avatar" style="object-fit: cover;"> -->
            <div class="c-meta">
              <div class="name-row">
                <strong>{{ comment.author.name }}</strong>
                <span class="verified-badge">Member</span>
              </div>
              <span class="c-date">{{ comment.createdAt | date:'mediumDate' }}</span>
            </div>
          </div>

          <div class="c-body">
            <p>{{ comment.content }}</p>
          </div>

          <div class="c-actions">
            <button class="btn-reply" (click)="openReplyInput(comment.id)">
              <i class="bi bi-reply"></i> Reply
            </button>
          </div>

          <div *ngIf="activeReplyId === comment.id" class="mt-3 ps-3 border-start border-3" style="border-color: #ff7f50 !important;">
            <div class="input-group input-group-sm">
              <input #replyInput type="text" class="form-control" placeholder="Write a reply..." style="border-radius: 8px 0 0 8px;">
              <button class="btn text-white" 
                      style="background-color: #ff7f50; border-radius: 0 8px 8px 0;"
                      (click)="submitReply(comment, replyInput.value)">Reply</button>
            </div>
          </div>

          <div *ngIf="comment.replies && comment.replies.length" class="mt-3 ps-4 border-start">
            <div *ngFor="let reply of comment.replies" class="mb-3 bg-white p-3 rounded-3 border">
               <div class="d-flex align-items-center gap-2 mb-2">
                  <!-- <img [src]="getAuthorImage(reply.author)" class="rounded-circle" style="width: 24px; height: 24px; object-fit: cover;"> -->
                  <strong class="small">{{ reply.author?.name }}</strong>
               </div>
               <p class="small mb-0 text-muted">{{ reply.content }}</p>
            </div>
          </div>

        </div>
        
        <p *ngIf="comments.length === 0" class="text-center text-muted py-4">
          No comments yet. Start the conversation!
        </p>
      </div>
    </div>

  </div>
</div>