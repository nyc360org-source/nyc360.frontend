<div class="housing-page">
    <!-- 1. Elegant Header -->
    <header class="housing-header">
        <span class="welcome-text">Welcome at NYC360</span>
        <h1 class="page-title">Housing</h1>
        <p class="page-subtitle">Where New Yorkers can share ideas, discussions, and local conversations</p>

        <div class="header-nav-buttons">
            <a routerLink="/public/housing/feed" class="nav-btn" routerLinkActive="active">
                <i class="bi bi-compass me-2"></i> Explore
            </a>
            <a routerLink="/public/housing/my-requests" class="nav-btn" routerLinkActive="active">
                <i class="bi bi-chat-left-text me-2"></i> My Inquiries
            </a>
            <a routerLink="/public/housing/agent/dashboard" class="nav-btn" routerLinkActive="active">
                <i class="bi bi-speedometer2"></i>
                Contributor Dashboard
            </a>
            <!-- Dropdown for Contributor Activity -->
            <div class="nav-dropdown-wrapper">
                <button class="nav-btn dropdown-toggle-btn">
                    <i class="bi bi-activity"></i>
                    Contributor Activity <i class="bi bi-chevron-down ms-2 small-arrow"></i>
                </button>
                <div class="dropdown-menu-custom">
                    <a [routerLink]="authService.hasHousingPermission() ? '/public/posts/create' : null"
                        [queryParams]="{ category: 4 }" class="dropdown-item-custom"
                        (click)="handleContributorAction($event)" [class.locked]="!authService.hasHousingPermission()">
                        <i class="bi"
                            [ngClass]="!authService.hasHousingPermission() ? 'bi-lock-fill' : 'bi-house-door'"></i>
                        Publish News Article
                    </a>

                    <a [routerLink]="authService.hasHousingPermission() ? '/public/rss/connect' : null"
                        [queryParams]="{ category: 4 }" class="dropdown-item-custom"
                        (click)="handleContributorAction($event)" [class.locked]="!authService.hasHousingPermission()">
                        <i class="bi"
                            [ngClass]="!authService.hasHousingPermission() ? 'bi-lock-fill' : 'bi-broadcast'"></i>
                        Connect RSS Feed
                    </a>

                    <a routerLink="/public/housing/create/renting" class="dropdown-item-custom">
                        <i class="bi bi-key"></i> House Listing
                    </a>
                </div>
            </div>

            <a routerLink="/public/forums/housing" class="nav-btn" routerLinkActive="active">
                <i class="bi bi-patch-question me-2"></i> Ask a Question
            </a>

        </div>

        <div class="breadcrumbs-overlay mt-4">
            <app-breadcrumbs></app-breadcrumbs>
        </div>
    </header>

    <div style="height: 30px;"></div>

    <!-- 2. Hero Component -->
    <div class="hero-container" *ngIf="heroPost">

        <div class="hero-premium-card">
            <div class="hero-visual">
                <ng-container *ngIf="heroPost.mediaUrl">
                    <video *ngIf="isVideo(heroPost.mediaUrl)" [src]="heroPost.mediaUrl" [muted]="true" [loop]="true"
                        autoplay playsinline class="w-100 h-100 object-fit-cover"></video>
                    <img *ngIf="!isVideo(heroPost.mediaUrl)" [src]="heroPost.mediaUrl" alt="Hero Featured">
                </ng-container>
            </div>
            <div class="hero-info">
                <div class="meta-tags">
                    <!-- <span class="status-badge" *ngIf="heroPost.metadata?.IsRenting">For Rent</span>
                    <span class="status-badge" *ngIf="!heroPost.metadata?.IsRenting">For Sale</span> -->
                    <span class="time">{{ heroPost.createdAt | date:'shortTime' }}</span>
                </div>
                <h2 class="hero-title">{{ heroPost.title }}</h2>
                <p class="hero-desc">
                    {{ heroPost.displayDescription | slice:0:180 }}
                </p>

                <div class="hero-meta mb-4" *ngIf="heroPost.metadata">
                    <span class="price-value" style="font-size: 1.8rem; color: #BC9D5F; font-weight: 800;">
                        {{ formatPrice(heroPost.metadata.Price || 0) }}{{ heroPost.metadata.IsRenting ? '/mo' : '' }}
                    </span>
                </div>

                <button class="btn-hero" [routerLink]="['/public/posts/details', heroPost.id]">View details</button>
            </div>
        </div>
    </div>

    <!-- 3. Navigation & Actions Bar -->


    <main class="content-body" *ngIf="!isLoading">

        <!-- 4. Homes For Sale Section -->
        <section class="section-wrapper" *ngIf="homesForSale.length > 0">
            <div class="section-head">
                <h3 class="section-title">Homes For Sale</h3>
                <a [routerLink]="['/public/housing/feed']" [queryParams]="{type: 'sale'}" class="view-all">View All</a>
            </div>
            <div class="housing-grid">
                <div class="premium-card" *ngFor="let item of homesForSale"
                    [routerLink]="['/public/housing/details', item.id]">

                    <div class="card-thumb">
                        <ng-container *ngIf="item.mediaUrl">
                            <video *ngIf="isVideo(item.mediaUrl)" [src]="item.mediaUrl" muted loop
                                onmouseover="this.play()" onmouseout="this.pause()"
                                class="w-100 h-100 object-fit-cover"></video>
                            <img *ngIf="!isVideo(item.mediaUrl)" [src]="item.mediaUrl" appImgFallback="housing">
                        </ng-container>
                        <div *ngIf="isVideo(item.mediaUrl)"
                            class="position-absolute top-50 start-50 translate-middle text-white"
                            style="pointer-events:none;"><i class="bi bi-play-circle-fill fs-3 shadow-lg"></i>
                        </div>
                        <span class="tag-price-badge">For Sale</span>
                    </div>


                    <div class="card-content">
                        <span class="loc-label">{{ item.location?.neighborhood || 'NYC Area' }}</span>
                        <h4 class="prop-title">{{ item.title }}</h4>
                        <div class="prop-stats">
                            <span><i class="bi bi-rulers"></i> {{ item.size }} SQFT</span>
                            <span><i class="bi bi-door-open"></i> {{ item.numberOfRooms }} ROOMS</span>
                            <span><i class="bi bi-droplet"></i> {{ item.numberOfBathrooms }} BATH</span>
                        </div>
                        <p class="price-value">{{ formatPrice(item.startingPrice) }}</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. Homes For Rent Section -->
        <section class="section-wrapper" *ngIf="homesForRent.length > 0">
            <div class="section-head">
                <h3 class="section-title">Homes For Rent</h3>
                <a [routerLink]="['/public/housing/feed']" [queryParams]="{type: 'rent'}" class="view-all">View All</a>
            </div>
            <div class="housing-grid four-cols">
                <div class="premium-card" *ngFor="let item of (homesForRent | slice:0:8)"
                    [routerLink]="['/public/housing/details', item.id]">

                    <div class="card-thumb">
                        <ng-container *ngIf="item.mediaUrl">
                            <video *ngIf="isVideo(item.mediaUrl)" [src]="item.mediaUrl" muted loop
                                onmouseover="this.play()" onmouseout="this.pause()"
                                class="w-100 h-100 object-fit-cover"></video>
                            <img *ngIf="!isVideo(item.mediaUrl)" [src]="item.mediaUrl" appImgFallback="housing">
                        </ng-container>
                        <div *ngIf="isVideo(item.mediaUrl)"
                            class="position-absolute top-50 start-50 translate-middle text-white"
                            style="pointer-events:none;"><i class="bi bi-play-circle-fill fs-3 shadow-lg"></i>
                        </div>
                        <span class="tag-price-badge">For Rent</span>
                    </div>


                    <div class="card-content">
                        <span class="loc-label">{{ item.location?.neighborhood || 'Upper West Side' }}</span>
                        <h4 class="prop-title">{{ item.title }}</h4>
                        <p class="price-value">{{ formatPrice(item.startingPrice) }}/mo</p>
                        <div class="prop-stats mt-2" style="background: none; padding: 0;">
                            <span><i class="bi bi-door-open"></i> {{ item.numberOfRooms }} Bed</span>
                            <span><i class="bi bi-droplet"></i> {{ item.numberOfBathrooms }} Bath</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- 6. Official Posts (RSS) Section -->
        <section class="section-wrapper" *ngIf="rssPosts.length > 0">
            <div class="section-head">
                <h3 class="section-title">NYC Housing Programs Official Posts</h3>
            </div>
            <div class="housing-grid">
                <div class="premium-card" *ngFor="let post of (rssPosts | slice:0:6)"
                    [routerLink]="['/public/posts/details', post.id]">

                    <div class="card-thumb" style="height: 220px;">
                        <ng-container *ngIf="post.mediaUrl">
                            <video *ngIf="isVideo(post.mediaUrl)" [src]="post.mediaUrl" muted loop
                                onmouseover="this.play()" onmouseout="this.pause()"
                                class="w-100 h-100 object-fit-cover"></video>
                            <img *ngIf="!isVideo(post.mediaUrl)" [src]="post.mediaUrl" appImgFallback="post">
                        </ng-container>
                        <div *ngIf="isVideo(post.mediaUrl)"
                            class="position-absolute top-50 start-50 translate-middle text-white"
                            style="pointer-events:none;"><i class="bi bi-play-circle-fill fs-3 shadow-lg"></i>
                        </div>
                    </div>

                    <div class="card-content">
                        <h4 class="prop-title">{{ post.title }}</h4>
                        <div class="prop-stats">
                            <span><i class="bi bi-building"></i> Programs</span>
                        </div>
                        <p class="price-value" style="font-size: 0.95rem; color: #999;">Read Official Guidelines</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7. Discussion Spotlight Section -->
        <section class="discussion-section" *ngIf="discussionPosts.length > 0">
            <div class="section-wrapper">
                <div class="discussion-spotlight" *ngFor="let post of (discussionPosts | slice:0:1)">
                    <div class="disc-meta">
                        <span class="user">{{ post.author?.fullName || post.CreatorName }}</span>
                        <span class="dot"></span>
                        <span>Housing</span>
                        <span class="dot"></span>
                        <span>{{ post.createdAt | date }}</span>
                    </div>
                    <h3 class="disc-title">{{ post.title }}</h3>
                    <p class="disc-body">"{{ post.displayDescription || post.content | slice:0:250 }}..."</p>
                    <div class="disc-footer">
                        <button class="btn-join-disc" [routerLink]="['/public/posts/details', post.id]">Read
                            More</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. All Posts Grid -->
        <section class="section-wrapper">
            <div class="section-head">
                <h3 class="section-title">All Posts</h3>
            </div>
            <div class="housing-grid four-cols">
                <div class="premium-card"
                    *ngFor="let item of (allPosts.length > 0 ? (allPosts | slice:0:8) : (homesForRent | slice:4:12))"
                    [routerLink]="['/public/housing/details', item.id]">

                    <div class="card-thumb">
                        <ng-container *ngIf="item.mediaUrl">
                            <video *ngIf="isVideo(item.mediaUrl)" [src]="item.mediaUrl" muted loop
                                onmouseover="this.play()" onmouseout="this.pause()"
                                class="w-100 h-100 object-fit-cover"></video>
                            <img *ngIf="!isVideo(item.mediaUrl)" [src]="item.mediaUrl" appImgFallback="housing">
                        </ng-container>
                        <div *ngIf="isVideo(item.mediaUrl)"
                            class="position-absolute top-50 start-50 translate-middle text-white"
                            style="pointer-events:none;"><i class="bi bi-play-circle-fill fs-3 shadow-lg"></i>
                        </div>
                    </div>

                    <div class="card-content">
                        <span class="loc-label">{{ item.location?.neighborhood || 'Manhattan' }}</span>
                        <h4 class="prop-title">{{ item.title }}</h4>
                        <p class="price-value">{{ formatPrice(item.startingPrice) }}</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 9. Quick Picks & Text Listings -->
        <section class="section-wrapper" *ngIf="textOnlyListings.length > 0">
            <div class="section-head">
                <h3 class="section-title">Quick Picks & Essential Listings</h3>
            </div>
            <div class="text-only-grid">
                <div class="text-listing-card" *ngFor="let item of textOnlyListings"
                    [routerLink]="[item.routingPath, item.id]">
                    <div class="card-header-row">
                        <span class="type-badge-mini" *ngIf="item.startingPrice || item.routingPath.includes('housing')"
                            [class.rent]="item.startingPrice < 50000 || item.title?.toLowerCase()?.includes('rent')">
                            {{ (item.startingPrice < 50000 || item.title?.toLowerCase()?.includes('rent')) ? 'For Rent'
                                : 'For Sale' }} </span>
                                <span class="type-badge-mini official"
                                    *ngIf="!item.startingPrice && !item.routingPath.includes('housing')">
                                    Official Post
                                </span>
                                <span class="price-text" *ngIf="item.startingPrice">{{ formatPrice(item.startingPrice)
                                    }}{{ (item.startingPrice < 50000 || item.title?.toLowerCase()?.includes('rent'))
                                        ? '/mo' : '' }}</span>
                    </div>
                    <h4 class="text-card-title">{{ item.title }}</h4>
                    <div class="text-card-meta">
                        <span *ngIf="item.location"><i class="bi bi-geo-alt"></i> {{ item.location?.neighborhood ||
                            'NYC' }}</span>
                        <span class="separator" *ngIf="item.location && item.numberOfRooms">â€¢</span>
                        <span *ngIf="item.numberOfRooms">{{ item.numberOfRooms }} Beds</span>
                        <span class="separator" *ngIf="item.numberOfRooms && item.numberOfBathrooms">â€¢</span>
                        <span *ngIf="item.numberOfBathrooms">{{ item.numberOfBathrooms }} Baths</span>
                        <span *ngIf="!item.startingPrice && item.author?.name"><i class="bi bi-building"></i> {{
                            item.author.name }}</span>
                    </div>
                    <div class="hover-indicator">Read Full Article <i class="bi bi-arrow-right"></i></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading State -->
    <div class="loading-overlay" *ngIf="isLoading">
        <div class="spinner-border text-gold" role="status"></div>
    </div>

    <!-- ðŸ” Verification Modal -->
    <div class="custom-modal-backdrop" *ngIf="showVerificationModal" (click)="closeModal()">
        <div class="verification-modal" (click)="$event.stopPropagation()">
            <div class="modal-header-premium">
                <div class="icon-badge">
                    <i class="bi bi-shield-lock-fill"></i>
                </div>
                <h3>Request Housing Access</h3>
                <p>To list properties or access the dashboard, you need to verify your housing contributor status.</p>
                <button class="btn-close-modal" (click)="closeModal()">&times;</button>
            </div>

            <div class="modal-body-premium">
                <form [formGroup]="verificationForm" (ngSubmit)="submitVerification()">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label-premium">Occupation / Role *</label>
                            <select class="form-control-premium" formControlName="occupationId">
                                <option *ngFor="let occ of occupations" [value]="occ.id">{{occ.name}}</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-4">
                            <label class="form-label-premium">Document Type *</label>
                            <select class="form-control-premium" formControlName="documentType">
                                <option *ngFor="let type of documentTypes" [value]="type.id">{{type.name}}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label class="form-label-premium">Reason for Request *</label>
                        <textarea class="form-control-premium" formControlName="reason"
                            placeholder="Explain why you need housing access (e.g., I am a licensed agent in NYC)"></textarea>
                        <small class="text-danger"
                            *ngIf="verificationForm.get('reason')?.touched && verificationForm.get('reason')?.invalid">
                            Required (min 10 characters).
                        </small>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <label class="form-label-premium">Supporting Document *</label>
                            <div class="file-upload-wrapper">
                                <input type="file" (change)="onFileSelected($event)" class="d-none" #docInput>
                                <button type="button" class="btn-upload-trigger" (click)="docInput.click()">
                                    <i class="bi bi-cloud-arrow-up me-2"></i>
                                    {{ selectedDocFile ? selectedDocFile.name : 'Choose File' }}
                                </button>
                                <small class="text-danger d-block mt-1"
                                    *ngIf="verificationForm.get('file')?.touched && !selectedDocFile">
                                    Please upload a document.
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer-premium">
                        <button type="button" class="btn-cancel" (click)="closeModal()">Cancel</button>
                        <button type="submit" class="btn-submit-verification" [disabled]="isSubmittingVerification">
                            <span *ngIf="isSubmittingVerification" class="spinner-border spinner-border-sm me-2"></span>
                            Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>