<div class="create-housing-container">
    <div class="container">
        <!-- Header -->
        <header class="page-header">
            <h2>Where are you Listing?</h2>
            <p>Share your property with the NYC360 community and find your perfect tenant or buyer.</p>
        </header>

        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="housing-form">

            <!-- 1. Rent / Sale Choice -->
            <section class="form-section no-bg mb-5">
                <div class="listing-type-group">
                    <div class="type-card-lg" [class.active]="isRenting" (click)="onListingTypeChange(true)">
                        <img src="assets/images/housing-rent-bg.jpg" alt="Rent" class="bg-img"
                            onerror="this.src='https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                        <div class="content">
                            <h3>For Rent</h3>
                            <p>List for Long-Term or Short-Term leases</p>
                        </div>
                        <div class="check-mark" *ngIf="isRenting"><i class="bi bi-check-lg"></i></div>
                    </div>
                    <div class="type-card-lg" [class.active]="!isRenting" (click)="onListingTypeChange(false)">
                        <img src="assets/images/housing-sale-bg.jpg" alt="Sale" class="bg-img"
                            onerror="this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                        <div class="content">
                            <h3>For Sale</h3>
                            <p>List as a Real Estate listing</p>
                        </div>
                        <div class="check-mark" *ngIf="!isRenting"><i class="bi bi-check-lg"></i></div>
                    </div>
                </div>
            </section>

            <!-- 2. Availability & Title -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-calendar-check me-2"></i>Availability</h3>
                <div class="row g-4">
                    <div class="col-md-4 form-group">
                        <label>Available From *</label>
                        <input type="date" class="form-control" formControlName="MoveInDate"
                            [class.is-invalid]="f['MoveInDate'].invalid && f['MoveInDate'].touched">
                    </div>
                    <div class="col-md-4 form-group">
                        <label>Available Until</label>
                        <input type="date" class="form-control" formControlName="MoveOutDate">
                    </div>
                    <div class="col-md-4 form-group" *ngIf="isRenting">
                        <label>Lease Type *</label>
                        <select class="form-select" formControlName="RentingLeaseType">
                            <option [ngValue]="null">Select Lease Type</option>
                            <option *ngFor="let l of leaseTypes" [ngValue]="l.id">{{ l.name }}</option>
                        </select>
                    </div>
                    <div class="col-md-12 form-group">
                        <label>Listing Title *</label>
                        <input type="text" class="form-control" formControlName="Title"
                            placeholder="e.g. Sunny 2BR in Williamsburg with Balcony">
                    </div>
                </div>
            </section>

            <!-- 3. Location & Address -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-geo-alt me-2"></i>Location</h3>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="row g-3">
                            <div class="col-md-9 form-group">
                                <label>City / Neighborhood (Search) *</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" placeholder="Search neighborhood..."
                                        (input)="onLocationInput($event)" formControlName="locationInput"
                                        [class.is-invalid]="f['locationInput'].invalid && f['locationInput'].touched">

                                    <div class="dropdown-results" *ngIf="showLocationDropdown">
                                        <div class="result-item" *ngFor="let loc of locationResults"
                                            (click)="selectLocation(loc)">
                                            <i class="bi bi-geo-fill"></i>
                                            <div class="d-flex flex-column">
                                                <span class="loc-name">{{ loc.neighborhood }}</span>
                                                <span class="loc-sub">{{ loc.borough }} â€¢ {{ loc.zipCode }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3 form-group" formGroupName="Address">
                                <label>Zip Code</label>
                                <input type="text" class="form-control" formControlName="ZipCode" placeholder="10001">
                            </div>

                            <div class="col-md-12 mt-2">
                                <h5 class="fw-bold mb-3 text-gold-dark"
                                    style="font-size: 0.9rem; letter-spacing: 0.5px; text-transform: uppercase;">Address
                                </h5>
                            </div>

                            <div class="col-md-12 form-group" formGroupName="Address">
                                <label>Street Name</label>
                                <input type="text" class="form-control" formControlName="Street"
                                    placeholder="e.g. Broadway">
                            </div>

                            <div class="col-md-6 form-group" formGroupName="Address">
                                <label>Building No.</label>
                                <input type="text" class="form-control" formControlName="BuildingNumber"
                                    placeholder="123">
                            </div>

                            <div class="col-md-6 form-group">
                                <label>Unit / Apt No.</label>
                                <input type="text" class="form-control" formControlName="UnitNumber" placeholder="4B">
                            </div>
                        </div>

                        <!-- Google Map Link (Outside Address Group) -->
                        <div class="row mt-3">
                            <div class="col-md-12 form-group">
                                <label>Google Maps Link</label>
                                <input type="text" class="form-control" formControlName="GoogleMapLink"
                                    placeholder="e.g. https://www.google.com/maps">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Rooms (Bed/Bath) -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-house me-2"></i>Rooms & Layout</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="mb-3">Bedrooms *</label>
                        <div class="pill-selector">
                            <button type="button" *ngFor="let n of [0,1,2,3,4,5]"
                                [class.active]="f['NumberOfRooms'].value === n"
                                (click)="f['NumberOfRooms'].setValue(n)">{{ n === 0 ? 'Studio' : n }}</button>
                            <button type="button" [class.active]="f['NumberOfRooms'].value >= 6"
                                (click)="f['NumberOfRooms'].setValue(6)">6+</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="mb-3">Bathrooms *</label>
                        <div class="pill-selector">
                            <button type="button" *ngFor="let n of [1,1.5,2,2.5,3,4]"
                                [class.active]="f['NumberOfBathrooms'].value === n"
                                (click)="f['NumberOfBathrooms'].setValue(n)">{{n}}</button>
                            <button type="button" [class.active]="f['NumberOfBathrooms'].value >= 5"
                                (click)="f['NumberOfBathrooms'].setValue(5)">5+</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Financials -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-currency-dollar me-2"></i>Financials</h3>
                <div class="row g-4">
                    <div class="col-md-3 form-group">
                        <label>{{ isRenting ? 'Monthly Rent' : 'Price' }} *</label>
                        <input type="number" class="form-control" formControlName="StartingPrice" placeholder="$">
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Security Deposit</label>
                        <input type="number" class="form-control" formControlName="SecurityDeposit" placeholder="$">
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Broker Fee</label>
                        <input type="number" class="form-control" formControlName="BrokerFee" placeholder="$">
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Monthly Cost rang </label>
                        <input type="number" class="form-control" formControlName="MonthlyCostRange" placeholder="$">
                    </div>
                </div>
            </section>

            <!-- 6. Property Details -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-building me-2"></i>Property Details</h3>

                <div class="mb-4">
                    <label class="mb-3">Building Type *</label>
                    <div class="radio-group-row">
                        <label class="radio-custom" *ngFor="let type of buildingTypeOptions">
                            <input type="radio" formControlName="BuildingType" [value]="type.id">
                            <span class="radio-mark"></span>
                            <span class="radio-label">{{type.name}}</span>
                        </label>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-3 form-group">
                        <label>Size (sqft)</label>
                        <input type="number" class="form-control" formControlName="Size" placeholder="450">
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Floor Level</label>
                        <input type="number" class="form-control" formControlName="FloorLevel" placeholder="2">
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Heating</label>
                        <select class="form-select" formControlName="HeatingSystem">
                            <option *ngFor="let t of heatingSystems" [ngValue]="t.id">{{t.name}}</option>
                        </select>
                    </div>
                    <div class="col-md-3 form-group">
                        <label>Cooling</label>
                        <select class="form-select" formControlName="CoolingSystem">
                            <option *ngFor="let t of coolingSystems" [ngValue]="t.id">{{t.name}}</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- 7. Amenities (Grid Toggles) -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-stars me-2"></i>Features & Amenities</h3>

                <div class="mb-5">
                    <label class="fw-bold mb-3">Laundry (Single-select or multi-select) *</label>
                    <div class="radio-group-row">
                        <label class="radio-custom" *ngFor="let l of laundryTypes">
                            <input type="radio" formControlName="LaundryType" [value]="l.id">
                            <span class="radio-mark"></span>
                            <span class="radio-label">{{l.name}}</span>
                        </label>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="fw-bold mb-3">Amenities (Single-select or multi-select) *</label>
                    <div class="amenities-grid">
                        <button type="button" class="btn-amenity" *ngFor="let amenity of amenityOptions"
                            [class.active]="f['Amenities'].value?.includes(amenity)" (click)="toggleAmenity(amenity)">
                            <i class="bi"
                                [ngClass]="f['Amenities'].value?.includes(amenity) ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                            <span class="ms-2">{{ amenity }}</span>
                        </button>
                    </div>
                </div>

                <div class="row row-cols-1 row-cols-md-2 g-4">
                    <div class="col" *ngFor="let t of [
                        {key: 'IsShortTermStayAllowed', title: 'Short-Term Allowed', desc: 'Stays under 6 months'},
                        {key: 'IsFurnished', title: 'Furnished', desc: 'Furniture included'},
                        {key: 'IsPetsFriendly', title: 'Pets Friendly', desc: 'Cats & dogs allowed'},
                        {key: 'IsFamilyAndKidsFriendly', title: 'Family Friendly', desc: 'Safe for kids'},
                        {key: 'IsAccessibilityFriendly', title: 'Accessible', desc: 'Wheelchair access'},
                        {key: 'IsSmokingAllowed', title: 'Smoking Allowed', desc: 'In-unit smoking'}
                    ]">
                        <div class="feature-toggle-card">
                            <div class="text-content">
                                <h6>{{t.title}}</h6>
                                <p class="mb-0">{{t.desc}}</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" [formControlName]="t.key">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-5">
                    <label class="fw-bold mb-3">Included Utilities</label>
                    <div class="amenities-grid">
                        <button type="button" class="btn-amenity" *ngFor="let u of utilityOptions"
                            [class.active]="f['UtilitiesIncluded'].value?.includes(u)" (click)="toggleUtility(u)">
                            <i class="bi"
                                [ngClass]="f['UtilitiesIncluded'].value?.includes(u) ? 'bi-check-circle-fill' : 'bi-circle'"></i>
                            <span class="ms-2">{{ u }}</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- 8. Description -->
            <section class="form-section mb-4">
                <h3 class="section-title"><i class="bi bi-card-text me-2"></i>Description</h3>
                <textarea class="form-control" rows="6" formControlName="Description"
                    placeholder="Describe your property..."></textarea>
            </section>

            <!-- 9. Renting Details (Conditional) -->
            <section class="form-section gold-bg-section mb-4" *ngIf="isRenting">
                <h3 class="section-title"><i class="bi bi-key me-2"></i>Renting Details</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="mb-3">Privacy Type *</label>
                        <div class="radio-group-row">
                            <label class="radio-custom" *ngFor="let p of privacyTypes">
                                <input type="radio" formControlName="PrivacyType" [value]="p.value"
                                    (change)="f['RentingIsShared'].setValue(p.value === 'Shared Unit')">
                                <span class="radio-mark"></span>
                                <span class="radio-label">{{p.label}}</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="feature-toggle-card p-3">
                            <div class="text-content">
                                <h6>Housing Vouchers</h6>
                                <p class="mb-0">Accept Section 8/CityFHEPS</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" formControlName="IsAcceptsHousingVouchers">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 10. Shared Unit Details (Conditional) -->
            <section class="form-section gold-bg-section mb-4" *ngIf="isShared && isRenting">
                <h3 class="section-title"><i class="bi bi-people me-2"></i>Shared Unit Details</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="mb-3">Bathroom</label>
                        <div class="radio-group-row">
                            <label class="radio-custom">
                                <input type="radio" formControlName="RentingIsSharedBathroom" [value]="false">
                                <span class="radio-mark"></span>
                                <span class="radio-label">Private Bathroom</span>
                            </label>
                            <label class="radio-custom">
                                <input type="radio" formControlName="RentingIsSharedBathroom" [value]="true">
                                <span class="radio-mark"></span>
                                <span class="radio-label">Shared Bathroom</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="mb-3">Kitchen *</label>
                        <div class="radio-group-row">
                            <label class="radio-custom">
                                <input type="radio" formControlName="RentingIsSharedKitchen" [value]="false">
                                <span class="radio-mark"></span>
                                <span class="radio-label">Private Kitchen</span>
                            </label>
                            <label class="radio-custom">
                                <input type="radio" formControlName="RentingIsSharedKitchen" [value]="true">
                                <span class="radio-mark"></span>
                                <span class="radio-label">Shared Kitchen</span>
                            </label>
                            <label class="radio-custom">
                                <input type="radio" formControlName="RentingIsSharedKitchen" [value]="null">
                                <span class="radio-mark"></span>
                                <span class="radio-label">No Kitchen</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <label>About Current Resident(s)</label>
                        <input type="text" class="form-control" formControlName="RentingAboutCurrentResident"
                            placeholder="Add Short Brief About Current Resident(s)">
                    </div>
                    <div class="col-md-12">
                        <label>Unit Rules & Policies</label>
                        <input type="text" class="form-control" formControlName="RentingRulesAndPolicies"
                            placeholder="List The Unit Rules & Policies">
                    </div>
                    <div class="col-md-12">
                        <label>Roommate's Group Chat</label>
                        <input type="text" class="form-control" formControlName="RentingRoommateGroupChat"
                            placeholder="Add Roommate Email/s address, to join the unite group chat.">
                    </div>
                </div>
            </section>

            <!-- 12. Media -->
            <section class="form-section mb-5">
                <h3 class="section-title"><i class="bi bi-images me-2"></i>Photos</h3>
                <div class="photo-upload-area dashed-border text-center">
                    <div class="icon-circle-gold mx-auto"><i class="bi bi-cloud-arrow-up-fill"></i></div>
                    <h4>Drag & Drop Photos Here</h4>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" multiple (change)="onFileSelect($event)" accept="image/*" class="d-none"
                        #fileInput>
                    <button type="button" class="btn-gold-soft mt-3" (click)="fileInput.click()">Select Files</button>

                    <div class="photo-previews mt-4" *ngIf="imagePreviews.length > 0">
                        <div class="preview-item" *ngFor="let img of imagePreviews; let i = index">
                            <img [src]="img" alt="Preview">
                            <button type="button" class="btn-remove" (click)="removeFile(i)">&times;</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <div class="form-actions-footer mt-5">
                <h4>Finish all details of your Property</h4>
                <p>Take the lead in your neighborhood. Start a new discussion group focused on the topics that matter
                    most to you</p>

                <div class="d-flex">
                    <button type="button" class="btn-save-draft" (click)="saveDraft()">Save a Draft</button>
                    <button type="submit" class="btn-post-listing" [disabled]="isSubmitting">
                        <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                        Post Listing
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>