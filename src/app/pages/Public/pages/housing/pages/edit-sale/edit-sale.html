<div class="create-housing-container">
    <div class="container">
        <!-- Header -->
        <header class="page-header text-center mb-5">
            <h1 class="fw-bold">Edit Your Sale Listing</h1>
            <p class="text-muted">Update the property details to reach potential buyers effectively.</p>
        </header>

        <div *ngIf="isLoading" class="text-center py-5">
            <div class="spinner-border text-gold" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Fetching listing details...</p>
        </div>

        <form *ngIf="!isLoading" [formGroup]="form" class="housing-form-premium" (ngSubmit)="onSubmit()">

            <!-- 1. Rent / Sale Choice Cards (Visual only) -->
            <section class="form-section no-bg mb-5 text-center">
                <div class="listing-type-group justify-content-center">
                    <div class="type-card-lg active">
                        <img src="assets/images/housing-sale-bg.jpg" alt="Sale" class="bg-img"
                            onerror="this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'">
                        <div class="content">
                            <h3>For Sale</h3>
                            <p>Editing Real Estate listing</p>
                        </div>
                        <div class="check-mark"><i class="bi bi-check-lg"></i></div>
                    </div>
                </div>

                <!-- Property Icons -->
                <div class="property-icons-row mt-5">
                    <div class="prop-icon-card" *ngFor="let type of houseTypes"
                        [class.selected]="f['HouseType'].value === type.id" (click)="f['HouseType'].setValue(type.id)">
                        <i class="bi" [ngClass]="type.icon"></i>
                        <span>{{ type.name }}</span>
                    </div>
                </div>
            </section>

            <!-- Availability (Opening Date) -->
            <section class="form-card mb-4">
                <h3 class="section-title">
                    Availability
                    <i class="bi bi-check-circle-fill completion-check"
                        [class.is-complete]="isSectionValid('availability')"></i>
                </h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label-premium">Opening Date *</label>
                        <div class="input-with-icon">
                            <input type="date" class="form-control-premium" formControlName="OpeningDate"
                                [class.is-invalid]="f['OpeningDate'].invalid && f['OpeningDate'].touched">
                            <i class="bi bi-calendar3"></i>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-premium">Property Type *</label>
                        <select class="form-select-premium" formControlName="PropertyType"
                            [class.is-invalid]="f['PropertyType'].invalid && f['PropertyType'].touched">
                            <option [ngValue]="null">Select Property Type</option>
                            <option *ngFor="let p of propertyTypes" [ngValue]="p.id">{{ p.name }}</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Location -->
            <section class="form-card mb-4">
                <h3 class="section-title">
                    Location
                    <i class="bi bi-check-circle-fill completion-check"
                        [class.is-complete]="isSectionValid('location')"></i>
                </h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label-premium">Borough *</label>
                        <select class="form-select-premium" formControlName="Borough"
                            [class.is-invalid]="f['Borough'].invalid && f['Borough'].touched">
                            <option value="">Select Borough</option>
                            <option *ngFor="let b of boroughs" [value]="b">{{ b }}</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-premium">ZIP Code *</label>
                        <input type="text" class="form-control-premium" formControlName="ZipCode"
                            [class.is-invalid]="f['ZipCode'].invalid && f['ZipCode'].touched"
                            placeholder="Enter ZIP Code">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-premium">Suggested Occupants</label>
                        <input type="number" class="form-control-premium" formControlName="SuggestedOccupants">
                    </div>
                </div>
            </section>

            <!-- Address -->
            <section class="form-card mb-4">
                <h3 class="section-title">Address</h3>
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label-premium">Neighborhood *</label>
                        <div class="position-relative">
                            <input type="text" class="form-select-premium" placeholder="Select Neighborhood"
                                [class.is-invalid]="f['locationInput'].invalid && f['locationInput'].touched"
                                (input)="onLocationInput($event)" formControlName="locationInput">
                            <div class="dropdown-results shadow-lg" *ngIf="showLocationDropdown">
                                <div class="result-item" *ngFor="let loc of locationResults"
                                    (click)="selectLocation(loc)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-600">{{ loc.neighborhood }}</span>
                                        <span class="text-muted small">#{{ loc.zipCode }}</span>
                                    </div>
                                    <div class="text-muted smaller">{{ loc.borough }}</div>
                                </div>
                            </div>
                            <i class="bi bi-chevron-down select-icon"></i>
                        </div>
                    </div>
                    <div class="col-md-6" formGroupName="Address">
                        <label class="form-label-premium">Full Address (optional)</label>
                        <input type="text" class="form-control-premium" formControlName="FullAddress">
                    </div>
                </div>
                <div class="row g-4 mb-4" formGroupName="Address">
                    <div class="col-md-6">
                        <label class="form-label-premium">Unit Number (optional)</label>
                        <input type="text" class="form-control-premium" formControlName="UnitNumber">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-premium">Google Map (optional)</label>
                        <input type="text" class="form-control-premium" formControlName="GoogleMap">
                    </div>
                </div>
            </section>

            <!-- Financials -->
            <section class="form-card mb-4">
                <h3 class="section-title">
                    Financials
                    <i class="bi bi-check-circle-fill completion-check"
                        [class.is-complete]="isSectionValid('financials')"></i>
                </h3>
                <div class="row g-4">
                    <div class="col-md-3">
                        <label class="form-label-premium">Asking Price($) *</label>
                        <input type="number" class="form-control-premium" formControlName="AskingPrice"
                            [class.is-invalid]="f['AskingPrice'].invalid && f['AskingPrice'].touched">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-premium">Down Payment($)</label>
                        <input type="number" class="form-control-premium" formControlName="DownPayment">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-premium">Broker Fee</label>
                        <input type="number" class="form-control-premium" formControlName="BrokerFee">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label-premium">Monthly Cost Range</label>
                        <input type="number" class="form-control-premium" formControlName="MonthlyCostRange">
                    </div>
                </div>
            </section>

            <!-- Key Details -->
            <section class="form-card mb-4">
                <h3 class="section-title">
                    Key Details
                    <i class="bi bi-check-circle-fill completion-check"
                        [class.is-complete]="isSectionValid('details')"></i>
                </h3>

                <div class="row g-4 mb-5">
                    <div class="col-md-6">
                        <label class="form-label-premium mb-3">Bedrooms *</label>
                        <div class="pill-group">
                            <button type="button" class="pill-btn" *ngFor="let n of [1,2,3,4,5]"
                                [class.active]="f['Bedrooms'].value === n" (click)="f['Bedrooms'].setValue(n)">{{ n
                                }}</button>
                            <button type="button" class="pill-btn" [class.active]="f['Bedrooms'].value >= 6"
                                (click)="f['Bedrooms'].setValue(6)">6+</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-premium mb-3">Bathrooms *</label>
                        <div class="pill-group">
                            <button type="button" class="pill-btn" *ngFor="let n of [1,2,3,4,5]"
                                [class.active]="f['Bathrooms'].value === n" (click)="f['Bathrooms'].setValue(n)">{{ n
                                }}</button>
                            <button type="button" class="pill-btn" [class.active]="f['Bathrooms'].value >= 6"
                                (click)="f['Bathrooms'].setValue(6)">6+</button>
                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="form-label-premium mb-4">Building Type *</label>
                    <div class="circle-radio-group">
                        <label class="circle-radio" *ngFor="let t of buildingTypes">
                            <input type="radio" formControlName="BuildingType" [value]="t.id">
                            <span class="custom-radio"></span>
                            <span class="radio-label">{{t.name}}</span>
                        </label>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label-premium">Sqft</label>
                        <input type="number" class="form-control-premium" formControlName="Sqft">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label-premium">Legal Unit Count</label>
                        <input type="number" class="form-control-premium" formControlName="LegalUnitCount">
                    </div>
                </div>
            </section>

            <!-- Description -->
            <section class="form-card mb-4">
                <h3 class="section-title">Description</h3>
                <textarea class="form-control-premium" style="min-height: 150px;"
                    [class.is-invalid]="f['Description'].invalid && f['Description'].touched"
                    formControlName="Description" placeholder="Update description..."></textarea>
            </section>

            <!-- Photos -->
            <section class="form-card mb-4">
                <h3 class="section-title">Photos</h3>

                <!-- Existing Photos -->
                <div class="photo-previews-grid mb-4" *ngIf="existingAttachments.length > 0">
                    <div class="preview-card" *ngFor="let att of existingAttachments; let i = index">
                        <img [src]="imageService.resolveImageUrl(att.url)" alt="Existing">
                        <button type="button" class="btn-remove-photo" (click)="removeExistingFile(i, att.id)"><i
                                class="bi bi-trash"></i></button>
                        <span class="existing-badge">Existing</span>
                    </div>
                </div>

                <div class="photo-upload-zone-premium" (click)="fileInput.click()">
                    <input type="file" multiple (change)="onFileSelect($event)" accept="image/*" class="d-none"
                        #fileInput>
                    <div class="upload-icon-circle">
                        <i class="bi bi-camera-fill"></i>
                        <div class="plus-icon">+</div>
                    </div>
                    <h4 class="fw-bold mt-3">Add New Photos</h4>
                </div>

                <!-- New Previews -->
                <div class="photo-previews-grid mt-4" *ngIf="imagePreviews.length > 0">
                    <div class="preview-card" *ngFor="let img of imagePreviews; let i = index">
                        <img [src]="img" alt="New Preview">
                        <button type="button" class="btn-remove-photo" (click)="removeFile(i)"><i
                                class="bi bi-x"></i></button>
                        <span class="new-badge">New</span>
                    </div>
                </div>
            </section>

            <!-- Actions -->
            <section class="finish-draft-card mb-5 text-center">
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn-draft-luxury" routerLink="/public/housing/home">Cancel</button>
                    <button type="submit" class="btn-post-luxury" [disabled]="isSubmitting">
                        <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                        Update Listing
                    </button>
                </div>
            </section>

        </form>
    </div>
</div>